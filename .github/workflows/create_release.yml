name: ğŸš€ Create pull request

on:
  workflow_dispatch : 
    inputs :
      branch :
        type : choice
        description :  'Branch to create pull request' 
        options:
          [ 'major', 'release', 'hotfix' ]
        required :  true 

jobs:

  # ë²„ì „ ë³€ê²½ ìš”ì²­ì¸ ê²½ìš°ì—ë§Œ, ë²„ì „ì„ ë³€ê²½í•¨.
  change-version:
    name : ğŸš€ Change release version
    runs-on: ubuntu-latest

    if: contains(fromJson('["release", "hotfix", "major"]'), github.event.inputs.branch)

    outputs:
      version: ${{ steps.update-version.outputs.version }} 
      branch: ${{ github.event.inputs.branch }}/${{ steps.update-version.outputs.version }}
    steps : 
      - name : ğŸš€ ê¹ƒ ì •ë³´ ë¡œë”©
        uses: actions/checkout@v3
        with : 
          ref : develop
    
      - name: âœ… Check And Set Node Version
        id : update-version
        run: |
          version=$(node -p 'require("./package.json").version')

          major=$(echo $version | cut -d. -f1)
          release=$(echo $version | cut -d. -f2)
          hotfix=$(echo $version | cut -d. -f3)
          
          if [[ ${{ github.event.inputs.branch }} == 'major' ]]; then
          # ì£¼ìš” ì—…ë°ì´íŠ¸
          major=$((major+1))
          release=0
          hotfix=0
          elif [[ ${{ github.event.inputs.branch }} == 'release' ]]; then
          # ê¸°ëŠ¥ì—…ë°ì´íŠ¸
          release=$((release+1))
          hotfix=0
          elif [[ ${{ github.event.inputs.branch }} == 'hotfix' ]]; then
          # hotFix
          hotfix=$((hotfix+1))
          fi

          version="$major.$release.$hotfix"

          echo "version=${version}" >> $GITHUB_OUTPUT
        shell: bash

  change-version-commit:
    name : ğŸš€ Create release branch
    needs: [ change-version ]
    runs-on: ubuntu-latest

    # continue-on-error: true

    strategy:
      matrix:
        node-version: [18.16.1]
    steps :
      - uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
          
      - uses: actions/checkout@v4
        with:
          ref : develop

      - name : ğŸš€ ë¦´ë¦¬ì¦ˆ ë²„ì „ ì»¤ë°‹
        run: |
          git checkout -b ${{ needs.change-version.outputs.branch }}

          git config --global user.email "github-actions@github.com"
          git config --global user.name "github-actions"
          
          npm pkg set version="${{ needs.change-version.outputs.version }}"
          git add package.json

          git commit -m "ğŸš€ Release version ${{ needs.change-version.outputs.version }}"
          git push --set-upstream origin ${{ needs.change-version.outputs.branch }}
        shell: bash

      - name : â— ë¸ŒëŸ°ì¹˜ ìƒì„± ì‹¤íŒ¨
        if: failure()
        run: |
          echo "ë¸ŒëŸ°ì¹˜ ìƒì„± ì‹¤íŒ¨ - ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë¸ŒëŸ°ì¹˜ ${{ needs.change-version.outputs.branch }} ì…ë‹ˆë‹¤."

          git config pull.rebase false

          git pull origin develop
          git checkout ${{ needs.change-version.outputs.branch }}
          echo "ë¸ŒëŸ°ì¹˜ ë³€ê²½ ì™„ë£Œ ${{ needs.change-version.outputs.branch }}"

          git pull origin ${{ needs.change-version.outputs.branch }}  --allow-unrelated-histories
          echo "ë¸ŒëŸ°ì¹˜ pull ì™„ë£Œ"

          
          git merge develop
          echo "ë¸ŒëŸ°ì¹˜ ë³‘í•©"

          git push --set-upstream origin ${{ needs.change-version.outputs.branch }}
        shell: bash

    
  create-pr:
    name : ğŸš€ Create pull request
    needs: [change-version, change-version-commit]
    runs-on: ubuntu-latest


    steps :
      - uses: actions/checkout@v4
        with:
          ref : ${{ needs.change-version.outputs.branch }}

      - name : ğŸš€ ê¹ƒ ì •ë³´ ë¡œë”©
        run : |
          git checkout ${{ needs.change-version.outputs.branch }}

      - name : ğŸš€ Create pull request

        uses : actions/github-script@v6
        with:
          script: |
            await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Release. ${{ needs.change-version.outputs.version }}',
              head: '${{ needs.change-version.outputs.branch }}',
              base: 'master',
              body: `# Release version ${{ needs.change-version.outputs.version }}

              ## Release branch
              ${{github.ref}}
              
              ## CheckList
              - [ ] ë¹Œë“œ í™˜ê²½ í™•ì¸
              - [ ] ì½”ë“œ ë¦¬ë·°
              - [ ] í…ŒìŠ¤íŠ¸ ë¹Œë“œ
              - [ ] í…ŒìŠ¤íŠ¸ ë°°í¬`
            })